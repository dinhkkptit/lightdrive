<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flask File Browser</title>
  <style>
    body { font-family: Arial; max-width: 1000px; margin: auto; padding: 20px; background: #fafafa; }
    h2 { color: #333; margin-bottom: 10px; }
    a { text-decoration: none; color: #007bff; }
    a:hover { text-decoration: underline; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f0f0f0; }
    tr:hover { background: #f9f9f9; }
    button { background: #007bff; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; }
    button:hover { background: #0056b3; }
    .delete-btn { background: #e74c3c; }
    .delete-btn:hover { background: #c0392b; }
    .upload-section { background: #f8f8f8; padding: 10px; border-radius: 6px; margin-bottom: 15px; position: relative; }
    .upload-menu {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      top: 50px;
      left: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .upload-menu button {
      background: none;
      color: #333;
      width: 100%;
      text-align: left;
      padding: 8px 12px;
    }
    .upload-menu button:hover {
      background: #f0f0f0;
    }
    .breadcrumb {
      margin: 10px 0;
      font-size: 14px;
    }
    .breadcrumb a {
      color: #007bff;
    }
    .breadcrumb span {
      color: #555;
    }
    #searchInput {
      padding: 6px 8px;
      width: 60%;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    #dropZone {
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #555;
      background: #fefefe;
      display: none;
      margin-bottom: 15px;
    }
    #dropZone.dragover {
      background: #e8f0fe;
      border-color: #0056b3;
    }
  </style>
</head>
<body>
  <h2>üìÇ Flask File Browser</h2>

  <!-- Breadcrumbs -->
  <div class="breadcrumb">
    <a href="{{ url_for('browse') }}">Home</a>
    {% if current %}
      {% set parts = current.split('/') %}
      {% for i in range(parts|length) %}
        ‚Ä∫
        {% set subpath = '/'.join(parts[:i+1]) %}
        {% if loop.last %}
          <span>{{ parts[i] }}</span>
        {% else %}
          <a href="{{ url_for('browse', subpath=subpath) }}">{{ parts[i] }}</a>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

  <!-- Upload Section -->
  <div class="upload-section">
    <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="path" value="{{ current }}">
      <input type="file" id="fileInput" name="file" multiple style="display:none;">
      <input type="file" id="folderInput" name="file" webkitdirectory directory multiple style="display:none;">
      <button type="button" id="uploadBtn">üì§ Upload</button>
      <div id="uploadMenu" class="upload-menu">
        <button type="button" onclick="chooseFiles()">üìÑ Upload Files</button>
        <button type="button" onclick="chooseFolder()">üìÅ Upload Folder</button>
      </div>
    </form>
  </div>

  <!-- Drag and Drop Zone -->
  <div id="dropZone">üìÇ Drop files or folders here to upload</div>

  <!-- Search Bar -->
  <input type="text" id="searchInput" placeholder="üîç Search files or folders...">

  <!-- File Table -->
  <table id="fileTable">
    <thead>
      <tr><th>Name</th><th>Type</th><th>Size</th><th>Modified</th><th>Actions</th></tr>
    </thead>
    <tbody>
    {% for d in dirs %}
      {% set d_path = get_path(d) %}
      <tr class="row-item">
        <td><a href="{{ url_for('browse', subpath=d) }}">üìÅ {{ d.split('/')[-1] }}</a></td>
        <td>Folder</td>
        <td>-</td>
        <td>{{ (os.path.getmtime(get_path(d)) | int) | datetimeformat }}</td>
        <td>
          <a href="{{ url_for('download_file', filename=d) }}">Download ZIP</a>
          <form action="{{ url_for('delete_file', filename=d) }}" method="post" style="display:inline;">
            <button class="delete-btn" type="submit">Delete</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% for f in files %}
      <tr class="row-item">
        <td>üìÑ {{ f.split('/')[-1] }}</td>
        <td>File</td>
        <td>{{ (os.path.getsize(get_path(f)) / 1024) | round(1) }} KB</td>
        <td>{{ (os.path.getmtime(get_path(f)) | int) | datetimeformat }}</td>
        <td>
          <a href="{{ url_for('download_file', filename=f) }}">Download</a>
          <form action="{{ url_for('delete_file', filename=f) }}" method="post" style="display:inline;">
            <button class="delete-btn" type="submit">Delete</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5"><i>No files or folders</i></td></tr>
    {% endfor %}
    </tbody>
  </table>

  <script>
    // Upload menu logic
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadMenu = document.getElementById("uploadMenu");
    const fileInput = document.getElementById("fileInput");
    const folderInput = document.getElementById("folderInput");
    const uploadForm = document.getElementById("uploadForm");

    uploadBtn.onclick = () => {
      uploadMenu.style.display = uploadMenu.style.display === "block" ? "none" : "block";
    };

    function chooseFiles() { uploadMenu.style.display = "none"; fileInput.click(); }
    function chooseFolder() { uploadMenu.style.display = "none"; folderInput.click(); }

    fileInput.addEventListener("change", () => { if (fileInput.files.length > 0) uploadForm.submit(); });
    folderInput.addEventListener("change", () => { if (folderInput.files.length > 0) uploadForm.submit(); });
    document.addEventListener("click", (e) => { if (!uploadBtn.contains(e.target) && !uploadMenu.contains(e.target)) uploadMenu.style.display = "none"; });

    // Drag & Drop upload
    const dropZone = document.getElementById("dropZone");
    document.body.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.style.display = "block";
      dropZone.classList.add("dragover");
    });
    document.body.addEventListener("dragleave", (e) => {
      if (e.target === document.body || e.pageY <= 0) {
        dropZone.classList.remove("dragover");
        dropZone.style.display = "none";
      }
    });
    document.body.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      dropZone.style.display = "none";
      const dt = e.dataTransfer;
      if (dt.items) {
        const items = [...dt.items];
        const files = items.map(item => item.getAsFile()).filter(f => f);
        const formData = new FormData(uploadForm);
        files.forEach(f => formData.append("file", f));
        fetch(uploadForm.action, { method: "POST", body: formData }).then(() => location.reload());
      }
    });

    // Live Search filter
    document.getElementById("searchInput").addEventListener("input", function() {
      const term = this.value.toLowerCase();
      document.querySelectorAll(".row-item").forEach(row => {
        const name = row.querySelector("td").innerText.toLowerCase();
        row.style.display = name.includes(term) ? "" : "none";
      });
    });
  </script>
</body>
</html>
